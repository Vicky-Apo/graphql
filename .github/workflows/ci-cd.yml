name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Job 1: Code Quality & Validation
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate HTML files
        run: |
          echo "üîç Checking HTML files..."
          find public -name "*.html" -type f | while read file; do
            echo "Validating: $file"
            if ! grep -q "<!DOCTYPE html>" "$file"; then
              echo "‚ùå Missing DOCTYPE in $file"
              exit 1
            fi
          done
          echo "‚úÖ HTML files validated"

      - name: Check JavaScript syntax
        run: |
          echo "üîç Checking JavaScript syntax..."
          find public/js -name "*.js" -type f | while read file; do
            echo "Checking: $file"
            node --check "$file"
          done
          echo "‚úÖ JavaScript syntax valid"

      - name: Security scan - Check for hardcoded secrets
        run: |
          echo "üîí Scanning for hardcoded secrets..."
          # Check for common password patterns
          if grep -r "password\s*=\s*['\"][^'\"]*['\"]" public/js/ --include="*.js"; then
            echo "‚ùå Found hardcoded password!"
            exit 1
          fi
          # Check for API keys
          if grep -r "api[_-]key\s*=\s*['\"][^'\"]*['\"]" public/js/ --include="*.js"; then
            echo "‚ùå Found hardcoded API key!"
            exit 1
          fi
          echo "‚úÖ No hardcoded secrets found"

      - name: Check for TODO/FIXME comments
        run: |
          echo "üìù Checking for TODO/FIXME comments..."
          if grep -r "TODO\|FIXME" public/js/ --include="*.js"; then
            echo "‚ö†Ô∏è Found TODO/FIXME comments (review before production)"
          else
            echo "‚úÖ No TODO/FIXME comments"
          fi

  # Job 2: Build and Test Docker Image
  docker:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          echo "üê≥ Building Docker image..."
          docker build -t graphql-profile:${{ github.sha }} .
          docker images

      - name: Test Docker image
        run: |
          echo "üß™ Testing Docker container..."
          
          # Start container
          docker run -d -p 8081:80 --name test-app graphql-profile:${{ github.sha }}
          
          # Wait for nginx to start
          sleep 5
          
          # Test HTTP response
          echo "Testing HTTP response..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081)
          
          if [ "$response" = "200" ]; then
            echo "‚úÖ HTTP test passed (200 OK)"
          else
            echo "‚ùå HTTP test failed (Status: $response)"
            docker logs test-app
            exit 1
          fi
          
          # Test if index.html is served
          echo "Testing if HTML is served..."
          if curl -s http://localhost:8081 | grep -q "Zone01"; then
            echo "‚úÖ Content test passed"
          else
            echo "‚ùå Content test failed"
            exit 1
          fi
          
          # Check security headers
          echo "Testing security headers..."
          headers=$(curl -s -I http://localhost:8081)
          
          if echo "$headers" | grep -q "X-Frame-Options"; then
            echo "‚úÖ X-Frame-Options header present"
          else
            echo "‚ö†Ô∏è X-Frame-Options header missing"
          fi
          
          # Stop and remove test container
          docker stop test-app
          docker rm test-app

      - name: Check Docker image size
        run: |
          echo "üìä Checking Docker image size..."
          size=$(docker images graphql-profile:${{ github.sha }} --format "{{.Size}}")
          echo "Image size: $size"
          
          # Warn if image is over 50MB
          size_mb=$(docker images graphql-profile:${{ github.sha }} --format "{{.Size}}" | sed 's/MB//')
          if [ "${size_mb%.*}" -gt 50 ]; then
            echo "‚ö†Ô∏è Warning: Image size is large (>50MB)"
          else
            echo "‚úÖ Image size is optimal"
          fi

  # Job 3: Deploy to GitHub Pages
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [lint, docker]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        run: |
          echo "## üöÄ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "üåê URL: https://vicky-apo.github.io/graphql/" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "üë§ Author: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY